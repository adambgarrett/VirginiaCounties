<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Virginia Localities</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <style>
    html,body{height:100%;margin:0}
    #app{display:flex;height:100%}
    #sidebar{width:360px;max-width:100%;border-right:1px solid #e5e5e5;padding:14px;overflow:auto;font:14px/1.35 system-ui,Segoe UI,Roboto,Helvetica,Arial}
    #map{flex:1}
    h3{margin:0 0 8px}
    .badge{display:inline-block;background:#eee;border-radius:999px;padding:2px 8px;margin-left:6px}
    .toolbar{display:flex;gap:8px;margin:8px 0 12px}
    .toolbar button{padding:6px 10px;border:1px solid #aaa;background:#fff;border-radius:6px;cursor:pointer}
    .group{margin-bottom:16px}
    .group h4{margin:12px 0 8px;font-size:14px}
    .pill{display:inline-block;margin:4px 6px 0 0}
    .two-range{display:grid;grid-template-columns:1fr 1fr auto;gap:8px;align-items:center}
    .two-range input[type="range"]{width:100%}
    .mono{font-family:ui-monospace,Consolas,monospace;color:#666}
    select{width:100%;padding:6px}
    input[type="text"]{width:100%;padding:6px}
  </style>
</head>
<body>
<div id="app">
  <div id="sidebar">
    <h3>Virginia Localities <span id="count" class="badge">0 selected</span></h3>
    <div style="color:#666">Filter counties & independent cities.</div>
    <div class="toolbar">
      <button id="btn-reset">Reset</button>
      <button id="btn-export">Export GEOIDs</button>
    </div>
    <div id="filters"></div>
  </div>
  <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
<script>
const GEOJSON_URL = 'virginia_counties.geojson';
const CSV_URL     = 'locality_data.csv';

// Base map
const map = L.map('map').setView([37.7, -78.5], 7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  attribution:'&copy; OpenStreetMap'
}).addTo(map);

let featureLayer, allFeatures=[], DYNAMIC_GROUPS=[];
let activeFilters={}, selectedGEOIDs = new Set();
const styles={match:{weight:1,color:'#333',fillOpacity:0.6},dim:{weight:0.5,color:'#999',fillOpacity:0.15}};

// Static filter groups
const STATIC_GROUPS = [
  {
    id:'type', label:'Type', type:'checkboxes',
    options:[
      {value:'County', label:'Counties (LSAD 06)'},
      {value:'Independent City', label:'Independent Cities (LSAD 25)'}
    ],
    get:f => (String(f.properties.lsad)==='25'?'Independent City':'County')
  },
  {
    id:'nameSearch', label:'Name contains', type:'text',
    get:f => (f.properties.name||'').toLowerCase(),
    compare:(value,get,f)=> get(f).includes(value.trim().toLowerCase())
  }
];

// UI render
const filtersDiv = document.getElementById('filters');
function renderFilters(){
  filtersDiv.innerHTML='';
  const GROUPS=[...STATIC_GROUPS, ...DYNAMIC_GROUPS];

  GROUPS.forEach(g=>{
    const wrap=document.createElement('div'); wrap.className='group';
    const title=document.createElement('h4'); title.textContent=g.label; wrap.appendChild(title);

    if(g.type==='checkboxes'){
      g.options.forEach(opt=>{
        const id=`${g.id}_${opt.value}`.replace(/\s+/g,'_');
        const label=document.createElement('label'); label.className='pill';
        label.innerHTML=`<input type="checkbox" id="${id}" data-group="${g.id}" value="${opt.value}"> ${opt.label}`;
        label.querySelector('input').addEventListener('change', applyFilters);
        wrap.appendChild(label);
      });
    } else if(g.type==='text'){
      const input=document.createElement('input');
      input.type='text'; input.placeholder='e.g., Fairfax';
      input.dataset.group=g.id;
      input.addEventListener('input', debounce(applyFilters,200));
      wrap.appendChild(input);
    } else if(g.type==='range2'){
      // two-handle slider (two inputs) + live readout
      const row=document.createElement('div'); row.className='two-range';
      const minIn=document.createElement('input');
      const maxIn=document.createElement('input');
      const val  =document.createElement('div');

      [minIn,maxIn].forEach((el,i)=>{
        el.type='range'; el.min=g.min; el.max=g.max; el.step=g.step||1;
        el.value = i===0 ? (g.defaultMin ?? g.min) : (g.defaultMax ?? g.max);
        el.dataset.group=g.id; el.dataset.role=(i===0?'min':'max');
        el.addEventListener('input',()=>{
          const minV=Number(minIn.value), maxV=Number(maxIn.value);
          if(minV>maxV){ // keep order
            if(el===minIn) maxIn.value=minV;
            else minIn.value=maxV;
          }
          val.textContent = g.format
            ? `${g.format(minIn.value)} — ${g.format(maxIn.value)}`
            : `${minIn.value} — ${maxIn.value}`;
          applyFilters();
        });
      });

      val.className='mono';
      val.textContent = g.format
        ? `${g.format(minIn.value)} — ${g.format(maxIn.value)}`
        : `${minIn.value} — ${maxIn.value}`;

      row.appendChild(minIn);
      row.appendChild(maxIn);
      row.appendChild(val);
      wrap.appendChild(row);

      const hint=document.createElement('div');
      hint.className='mono';
      hint.style.marginTop='4px';
      hint.textContent=`min ${g.format?g.format(g.min):g.min} | max ${g.format?g.format(g.max):g.max}`;
      wrap.appendChild(hint);
    } else if(g.type==='multiselect'){
      const sel=document.createElement('select');
      sel.multiple=true; sel.size=Math.min(8,(g.options||[]).length);
      (g.options||[]).forEach(opt=>{
        const o=document.createElement('option'); o.value=opt.value; o.textContent=opt.label||opt.value; sel.appendChild(o);
      });
      sel.dataset.group=g.id;
      sel.addEventListener('change', applyFilters);
      wrap.appendChild(sel);
    }
    filtersDiv.appendChild(wrap);
  });
}

document.getElementById('btn-reset').onclick=()=>{
  filtersDiv.querySelectorAll('input,select').forEach(el=>{
    if(el.type==='checkbox') el.checked=false;
    else if(el.type==='text') el.value='';
    else if(el.type==='range'){
      const g = [...STATIC_GROUPS, ...DYNAMIC_GROUPS].find(x=>x.id===el.dataset.group);
      el.value = (el.dataset.role==='min') ? (g.defaultMin ?? g.min) : (g.defaultMax ?? g.max);
    } else if(el.tagName==='SELECT'){
      [...el.options].forEach(o=>o.selected=false);
    }
  });
  applyFilters();
};

document.getElementById('btn-export').onclick=()=>{
  const ids=[...selectedGEOIDs].sort();
  const blob=new Blob([ids.join('\n')],{type:'text/plain'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='va_geoids.txt';
  a.click();
};

// collect UI state
function collectFilterState(){
  const s={};
  filtersDiv.querySelectorAll('[data-group]').forEach(el=>{
    const gid=el.dataset.group;
    if(el.type==='checkbox'){
      s[gid]=s[gid]||[];
      if(el.checked) s[gid].push(el.value);
    } else if(el.type==='range'){
      s[gid]=s[gid]||{};
      s[gid][el.dataset.role]=Number(el.value);
    } else if(el.type==='text'){
      s[gid]=el.value||'';
    } else if(el.tagName==='SELECT'){
      s[gid]=[...el.selectedOptions].map(o=>o.value);
    }
  });
  return s;
}

const countSpan=document.getElementById('count');

function featureMatches(f){
  const GROUPS=[...STATIC_GROUPS, ...DYNAMIC_GROUPS];
  for(const g of GROUPS){
    const v=activeFilters[g.id];
    const getVal=g.get || (ff=>ff.properties[g.id]);

    if(g.type==='checkboxes'){
      if(v && v.length && !v.includes(getVal(f))) return false;
    } else if(g.type==='text'){
      if(v && v.trim() && !g.compare(v,getVal,f)) return false;
    } else if(g.type==='range2'){
      if(v && typeof v.min==='number' && typeof v.max==='number'){
        const x=getVal(f);
        if(!Number.isFinite(x) || x<v.min || x>v.max) return false;
      }
    } else if(g.type==='multiselect'){
      if(v && v.length){
        if(!v.includes(getVal(f))) return false;
      }
    }
  }
  return true;
}

function applyFilters(){
  activeFilters=collectFilterState();
  selectedGEOIDs.clear();
  featureLayer.eachLayer(l=>{
    const f=l.feature;
    const ok=featureMatches(f);
    l.setStyle(ok?styles.match:styles.dim);
    if(ok) selectedGEOIDs.add(String(f.properties.geoid));
  });
  countSpan.textContent=`${selectedGEOIDs.size} selected`;
}

// load data & join
Promise.all([
  fetch(GEOJSON_URL).then(r=>r.json()),
  fetch(CSV_URL).then(r=>r.text())
]).then(([geojson, csv])=>{
  const parsed = Papa.parse(csv,{header:true,dynamicTyping:true,skipEmptyLines:true});
  const byId=new Map();
  parsed.data.forEach(row=>{
    const id=String(row.geoid||'').padStart(5,'0');
    byId.set(id,row);
  });

  // augment features
  allFeatures = geojson.features.map(f=>{
    f.properties.lsad = String(f.properties.lsad ?? '');
    f.properties.geoid = String(f.properties.geoid ?? f.properties.GEOID ?? '').padStart(5,'0');
    f.properties.name = f.properties.name ?? f.properties.NAME ?? '';
    const extra = byId.get(f.properties.geoid);
    if(extra){
      f.properties.pop_density                 = +extra.pop_density;
      f.properties.pop_growth_10yr             = +extra.pop_growth_10yr;
      f.properties.real_estate_tax_min         = +extra.real_estate_tax_min;
      f.properties.real_estate_tax_max         = +extra.real_estate_tax_max;
      f.properties.msa_name                    = (extra.msa_name||'(none)').toString();
      f.properties.msa_type                    = (extra.msa_type||'None').toString();
      f.properties.personal_property_tax_rate  = +extra.personal_property_tax_rate;
    } else {
      f.properties.msa_name='(none)'; f.properties.msa_type='None';
    }
    return f;
  });

  // helpers to build ranges
  const nums = field => allFeatures.map(f=>f.properties[field]).filter(Number.isFinite);
  const minmax = field => {
    const a=nums(field); return a.length?[Math.min(...a), Math.max(...a)]:[0,0];
  };

  const [pdMin,pdMax]       = minmax('pop_density');
  const [pgMin,pgMax]       = minmax('pop_growth_10yr');
  const [rtMinMin,rtMinMax] = minmax('real_estate_tax_min');
  const [rtMaxMin,rtMaxMax] = minmax('real_estate_tax_max');
  const [ppMin,ppMax]       = minmax('personal_property_tax_rate');

  const uniq = arr => [...new Set(arr)].sort();
  const msaTypes = uniq(allFeatures.map(f=>f.properties.msa_type || 'None'));
  const msaNames = uniq(allFeatures.map(f=>f.properties.msa_name || '(none)'));

  // dynamic groups (all 2-handle sliders)
  DYNAMIC_GROUPS = [
    {
      id:'pop_density', label:'Population density (per km²)', type:'range2',
      min:Math.floor(pdMin), max:Math.ceil(pdMax), defaultMin:Math.floor(pdMin), defaultMax:Math.ceil(pdMax),
      get:f=>f.properties.pop_density
    },
    {
      id:'pop_growth_10yr', label:'Population growth (10y, %)', type:'range2',
      min:Math.floor(pgMin), max:Math.ceil(pgMax), defaultMin:Math.floor(pgMin), defaultMax:Math.ceil(pgMax),
      get:f=>f.properties.pop_growth_10yr,
      format:v=>`${Number(v).toFixed(0)}%`
    },
    {
      id:'real_estate_tax_min', label:'Real estate tax MIN (rate)', type:'range2',
      min:+rtMinMin.toFixed(4), max:+rtMinMax.toFixed(4),
      defaultMin:+rtMinMin.toFixed(4), defaultMax:+rtMinMax.toFixed(4), step:0.0001,
      get:f=>f.properties.real_estate_tax_min,
      format:v=>`${(Number(v)*100).toFixed(2)}%`
    },
    {
      id:'real_estate_tax_max', label:'Real estate tax MAX (rate)', type:'range2',
      min:+rtMaxMin.toFixed(4), max:+rtMaxMax.toFixed(4),
      defaultMin:+rtMaxMin.toFixed(4), defaultMax:+rtMaxMax.toFixed(4), step:0.0001,
      get:f=>f.properties.real_estate_tax_max,
      format:v=>`${(Number(v)*100).toFixed(2)}%`
    },
    {
      id:'personal_property_tax_rate', label:'Personal property tax (rate)', type:'range2',
      min:+ppMin.toFixed(3), max:+ppMax.toFixed(3),
      defaultMin:+ppMin.toFixed(3), defaultMax:+ppMax.toFixed(3), step:0.0005,
      get:f=>f.properties.personal_property_tax_rate,
      format:v=>`${(Number(v)*100).toFixed(2)}%`
    },
    {
      id:'msa_type', label:'MSA type', type:'checkboxes',
      options: msaTypes.map(v=>({value:v,label:v})),
      get:f=>f.properties.msa_type
    },
    {
      id:'msa_name', label:'MSA name(s)', type:'multiselect',
      options: msaNames.map(v=>({value:v,label:v})),
      get:f=>f.properties.msa_name
    }
  ];

  renderFilters();

  featureLayer = L.geoJSON({type:'FeatureCollection',features:allFeatures},{
    style:styles.match,
    onEachFeature:(f,layer)=>{
      const t=(String(f.properties.lsad)==='25')?'Independent City':'County';
      const dens = Number.isFinite(f.properties.pop_density)?`${f.properties.pop_density.toFixed(0)} /km²`:'–';
      const grow = Number.isFinite(f.properties.pop_growth_10yr)?`${f.properties.pop_growth_10yr.toFixed(1)}%`:'–';
      const reMin= Number.isFinite(f.properties.real_estate_tax_min)?`${(f.properties.real_estate_tax_min*100).toFixed(2)}%`:'–';
      const reMax= Number.isFinite(f.properties.real_estate_tax_max)?`${(f.properties.real_estate_tax_max*100).toFixed(2)}%`:'–';
      const pp  = Number.isFinite(f.properties.personal_property_tax_rate)?`${(f.properties.personal_property_tax_rate*100).toFixed(2)}%`:'–';
      const msa = (f.properties.msa_name && f.properties.msa_name!=='(none)')?`${f.properties.msa_name} (${f.properties.msa_type})`:'None';
      layer.bindPopup(
        `<b>${f.properties.name}</b> (${t})<br>
         GEOID: ${f.properties.geoid}<br>
         Pop density: ${dens}<br>
         10y growth: ${grow}<br>
         Real estate tax: min ${reMin}, max ${reMax}<br>
         Personal property tax: ${pp}<br>
         MSA: ${msa}`
      );
    }
  }).addTo(map);

  map.fitBounds(featureLayer.getBounds(),{padding:[20,20]});
  applyFilters();
});

// utils
function debounce(fn,ms=150){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; }
</script>
</body>
</html>


